@model LicenseManagement.Web.ViewModels.Notifications.NotificationListViewModel
@{
    ViewData["Title"] = "Notifications";
}

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Notifications</h1>
        <p class="page-description">View system notifications and alerts</p>
    </div>
    <div class="page-header-actions">
        <form method="post" asp-action="MarkAllAsRead" style="display: inline;">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-secondary">
                <i class="fas fa-check-double"></i>
                Mark All as Read
            </button>
        </form>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="form-label">Status</label>
                    <div class="btn-group-filter">
                        <a href="/notifications" class="btn @(string.IsNullOrEmpty(Model.StatusFilter) ? "btn-primary" : "btn-outline")">All</a>
                        <a href="/notifications?unreadOnly=true" class="btn @(Model.StatusFilter == "unread" ? "btn-primary" : "btn-outline")">Unread</a>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select">
                        <option value="">All Types</option>
                        <option value="License Approval" selected="@(Model.TypeFilter == "License Approval")">License Approval</option>
                        <option value="Payment Confirmation" selected="@(Model.TypeFilter == "Payment Confirmation")">Payment Confirmation</option>
                        <option value="Expiry Reminder" selected="@(Model.TypeFilter == "Expiry Reminder")">Expiry Reminder</option>
                        <option value="Welcome Email" selected="@(Model.TypeFilter == "Welcome Email")">Welcome Email</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Notifications List -->
<div class="notifications-list">
    @foreach (var notification in Model.Notifications.Items)
    {
        <div class="notification-item @(notification.Status == "Sent" ? "" : "unread")">
            <div class="notification-icon @GetIconColor(notification.NotificationType)">
                <i class="@GetIcon(notification.NotificationType)"></i>
            </div>
            <div class="notification-content">
                <div class="notification-header">
                    <h4 class="notification-subject">@notification.Subject</h4>
                    <span class="notification-time">@GetTimeAgo(notification.CreatedAt)</span>
                </div>
                <p class="notification-recipient">
                    <i class="fas fa-envelope"></i> @notification.Recipient
                </p>
                <div class="notification-meta">
                    <span class="badge badge-@GetStatusBadgeColor(notification.Status)">@notification.Status</span>
                    <span class="notification-type">@notification.NotificationType</span>
                </div>
                @if (!string.IsNullOrEmpty(notification.ErrorMessage))
                {
                    <p class="notification-error">
                        <i class="fas fa-exclamation-circle"></i> @notification.ErrorMessage
                    </p>
                }
            </div>
            <div class="notification-actions">
                @if (notification.Status != "Sent")
                {
                    <form method="post" asp-action="MarkAsRead" asp-route-id="@notification.Id" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline" title="Mark as read">
                            <i class="fas fa-check"></i>
                        </button>
                    </form>
                }
                <form method="post" asp-action="Delete" asp-route-id="@notification.Id" style="display: inline;"
                      onsubmit="return confirm('Are you sure you want to delete this notification?');">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
        </div>
    }
</div>

@if (!Model.Notifications.Items.Any())
{
    <div class="empty-state">
        <i class="fas fa-bell-slash"></i>
        <h3>No notifications</h3>
        <p>You're all caught up! No notifications to display.</p>
    </div>
}

@if (Model.Notifications.TotalPages > 1)
{
    <div class="pagination-wrapper">
        <vc:pagination current-page="@Model.Notifications.PageNumber" 
                      total-pages="@Model.Notifications.TotalPages" 
                      page-size="@Model.Notifications.PageSize" />
    </div>
}

@section Styles {
    <style>
        .mb-4 { margin-bottom: 1rem; }
        
        .btn-group-filter {
            display: flex;
            gap: 0;
        }
        
        .btn-group-filter .btn {
            border-radius: 0;
        }
        
        .btn-group-filter .btn:first-child {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }
        
        .btn-group-filter .btn:last-child {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }
        
        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .notification-item {
            display: flex;
            gap: 1rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1.25rem;
            transition: box-shadow 0.2s;
        }
        
        .notification-item:hover {
            box-shadow: var(--shadow-md);
        }
        
        .notification-item.unread {
            border-left: 3px solid var(--primary);
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification-icon.primary {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }
        
        .notification-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .notification-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .notification-icon.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .notification-subject {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }
        
        .notification-time {
            font-size: 0.75rem;
            color: var(--gray-400);
            white-space: nowrap;
        }
        
        .notification-recipient {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin: 0.25rem 0 0.5rem 0;
        }
        
        .notification-recipient i {
            margin-right: 0.25rem;
        }
        
        .notification-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .notification-type {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .notification-error {
            font-size: 0.75rem;
            color: var(--danger);
            margin: 0.5rem 0 0 0;
        }
        
        .notification-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }
        
        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-700);
        }
        
        .empty-state p {
            color: var(--gray-500);
        }
        
        .pagination-wrapper {
            margin-top: 1.5rem;
        }
    </style>
}

@functions {
    private string GetIcon(string type) => type switch
    {
        "License Approval" => "fas fa-check-circle",
        "Payment Confirmation" => "fas fa-dollar-sign",
        "Expiry Reminder" => "fas fa-exclamation-triangle",
        "Welcome Email" => "fas fa-user-plus",
        _ => "fas fa-bell"
    };

    private string GetIconColor(string type) => type switch
    {
        "License Approval" => "success",
        "Payment Confirmation" => "info",
        "Expiry Reminder" => "warning",
        "Welcome Email" => "primary",
        _ => "primary"
    };

    private string GetStatusBadgeColor(string status) => status switch
    {
        "Sent" => "success",
        "Pending" => "warning",
        "Failed" => "danger",
        _ => "secondary"
    };

    private string GetTimeAgo(DateTime timestamp)
    {
        var diff = DateTime.UtcNow - timestamp;
        
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        
        return timestamp.ToString("MMM dd, yyyy");
    }
}
